<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TTTA - Export Candidates</title>
    <link rel="stylesheet" href="./index.css" />
    <link
      rel="shortcut icon"
      href="https://res.cloudinary.com/postman/image/upload/v1610442763/team/oal3holec8tcwcdl9eyl.ico"
    />
  </head>

  <body>
    <div class="container">
      <h1>Candidates Export</h1>
      <p class="subtitle">Download candidates with their applications as CSV</p>

      <button id="downloadBtn" class="download-btn">
        <svg
          width="20"
          height="20"
          viewBox="0 0 20 20"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path d="M10 13L5 8H8V3H12V8H15L10 13Z" fill="currentColor" />
          <path d="M3 15V17H17V15H3Z" fill="currentColor" />
        </svg>
        Download CSV
      </button>

      <div id="status" class="status"></div>
    </div>

    <script>
      const API_URL = "http://localhost:3000";
      const downloadBtn = document.getElementById("downloadBtn");
      const statusEl = document.getElementById("status");

      function showStatus(message, type = "info") {
        statusEl.textContent = message;
        statusEl.className = `status ${type} show`;

        if (type === "success" || type === "error") {
          setTimeout(() => {
            statusEl.classList.remove("show");
          }, 3000);
        }
      }

      async function downloadCSV() {
        downloadBtn.disabled = true;
        showStatus("Generating CSV...", "info");

        try {
          const response = await fetch(`${API_URL}/api/v1/export-csv`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          if (!response.ok) {
            throw new Error(`Server returned ${response.status}`);
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `candidates-${new Date().toISOString().split("T")[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);

          showStatus("CSV downloaded successfully!", "success");
        } catch (error) {
          console.error("Download failed:", error);
          showStatus("Failed to download CSV: " + error.message, "error");
        } finally {
          downloadBtn.disabled = false;
        }
      }

      downloadBtn.addEventListener("click", downloadCSV);
    </script>
  </body>
</html>
